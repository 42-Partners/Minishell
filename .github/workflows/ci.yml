name: Minishell CI

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ dev, main ]

jobs:
  norminette:
    name: Norminette Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install norminette
      run: pip3 install norminette
    
    - name: Run norminette
      run: |
        echo "Running norminette..."
        NORM=$(norminette | grep Error: || true)
        if [ -n "$NORM" ]; then
          echo "Norminette failed"
          exit 1
        fi
        echo "Norminette passed"

  compile:
    name: Compile
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libreadline-dev
    
    - name: Compile minishell
      run: |
        echo "Compiling..."
        make
        echo "Compilation successful!"
    
    - name: Check executable
      run: |
        if [ ! -f "./minishell" ]; then
          echo "minishell executable not found!"
          exit 1
        fi
        echo "Executable created successfully"
    
    - name: Upload minishell binary
      uses: actions/upload-artifact@v4
      with:
        name: minishell-binary
        path: minishell
        retention-days: 1

  # test:
  #   name: Functional Tests
  #   runs-on: ubuntu-latest
  #   needs: compile
    
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #     with:
  #       submodules: recursive
    
  #   - name: Install dependencies
  #     run: |
  #       sudo apt-get update
  #       sudo apt-get install -y libreadline-dev
    
  #   - name: Download minishell binary
  #     uses: actions/download-artifact@v4
  #     with:
  #       name: minishell-binary
    
  #   - name: Make binary executable
  #     run: chmod +x minishell
    
  #   - name: Run functional tests
  #     run: |
  #       if [ -f "tests/run_tests.sh" ]; then
  #         echo "Running functional tests..."
  #         bash tests/run_tests.sh
  #       else
  #         echo "tests/run_tests.sh not found, running basic tests..."
  #         # Testes bÃ¡sicos inline
  #         echo "echo test" | ./minishell
  #         echo "pwd" | ./minishell
  #         echo "env" | ./minishell
  #         echo "Basic tests passed"
  #       fi

  # memory:
  #   name: Memory Leak Detection
  #   runs-on: ubuntu-latest
  #   # needs: test
    
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #     with:
  #       submodules: recursive
    
  #   - name: Install dependencies
  #     run: |
  #       sudo apt-get update
  #       sudo apt-get install -y valgrind libreadline-dev
    
  #   - name: Compile minishell
  #     run: make
    
  #   - name: Make scripts executable
  #     run: |
  #       chmod +x tests/valgrind_quick.sh 2>/dev/null || true
  #       chmod +x tests/valgrind_full.sh 2>/dev/null || true
    
  #   - name: Quick memory check (dev)
  #     if: github.ref == 'refs/heads/dev' || github.base_ref == 'dev'
  #     run: |
  #       if [ -f "tests/valgrind_quick.sh" ]; then
  #         echo "Running quick valgrind check..."
  #         bash tests/valgrind_quick.sh
  #       else
  #         echo "tests/valgrind_quick.sh not found"
  #         echo "Running basic valgrind test..."
  #         echo "echo test" | valgrind --leak-check=yes --error-exitcode=1 ./minishell
  #       fi
  #     continue-on-error: true
    
  #   - name: Full memory check (main)
  #     if: github.ref == 'refs/heads/main' || github.base_ref == 'main'
  #     run: |
  #       if [ -f "tests/valgrind_full.sh" ]; then
  #         echo "Running full valgrind check..."
  #         bash tests/valgrind_full.sh
  #       else
  #         echo "tests/valgrind_full.sh not found!"
  #         exit 1
  #       fi